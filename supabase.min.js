(function(window) {
    window.supabase = {
        createClient: function(url, key) {
            function SupabaseClient(supabaseUrl, supabaseKey) {
                this.supabaseUrl = supabaseUrl;
                this.supabaseKey = supabaseKey;
            }

            SupabaseClient.prototype.from = function(table) {
                var self = this;
                
                return {
                    select: function(columns) {
                        var url = self.supabaseUrl + '/rest/v1/' + table + '?select=' + columns;
                        
                        var query = {
                            method: 'GET',
                            url: url,
                            headers: {
                                'apikey': self.supabaseKey,
                                'Authorization': 'Bearer ' + self.supabaseKey
                            }
                        };
                        
                        return {
                            then: function(callback) {
                                return fetch(query.url, {
                                    method: query.method,
                                    headers: query.headers
                                }).then(function(response) {
                                    return response.json();
                                }).then(function(result) {
                                    // 包装结果以匹配Supabase格式
                                    return callback({
                                        data: result,
                                        error: null
                                    });
                                }).catch(function(error) {
                                    return callback({
                                        data: null,
                                        error: error
                                    });
                                });
                            },
                            eq: function(column, value) {
                                query.url += '&' + column + '=eq.' + value;
                                return this;
                            },
                            single: function() {
                                query.url += '&limit=1';
                                return this;
                            },
                            limit: function(count) {
                                query.url += '&limit=' + count;
                                return this;
                            },
                            order: function(column, options) {
                                var order = options && options.ascending ? 'asc' : 'desc';
                                query.url += '&order=' + column + '.' + order;
                                return this;
                            }
                        };
                    },
                    
                    insert: function(data) {
                        var url = self.supabaseUrl + '/rest/v1/' + table;
                        return {
                            then: function(callback) {
                                return fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'apikey': self.supabaseKey,
                                        'Authorization': 'Bearer ' + self.supabaseKey,
                                        'Content-Type': 'application/json',
                                        'Prefer': 'return=representation'
                                    },
                                    body: JSON.stringify(data)
                                }).then(function(response) {
                                    return response.json();
                                }).then(function(result) {
                                    return callback({
                                        data: result,
                                        error: null
                                    });
                                }).catch(function(error) {
                                    return callback({
                                        data: null,
                                        error: error
                                    });
                                });
                            }
                        };
                    }
                };
            };

            return new SupabaseClient(url, key);
        }
    };
})(window);
