(function(window) {
    window.supabase = {
        createClient: function(url, key) {
            function SupabaseClient(supabaseUrl, supabaseKey) {
                this.supabaseUrl = supabaseUrl;
                this.supabaseKey = supabaseKey;
            }

            SupabaseClient.prototype.from = function(table) {
                var self = this;
                
                return {
                    select: function(columns) {
                        var url = self.supabaseUrl + '/rest/v1/' + table + '?select=' + columns;
                        return fetch(url, {
                            headers: {
                                'apikey': self.supabaseKey,
                                'Authorization': 'Bearer ' + self.supabaseKey
                            }
                        }).then(function(response) {
                            return response.json();
                        });
                    },
                    
                    insert: function(data, options) {
                        var url = self.supabaseUrl + '/rest/v1/' + table;
                        var headers = {
                            'apikey': self.supabaseKey,
                            'Authorization': 'Bearer ' + self.supabaseKey,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        };
                        
                        if (options && options.upsert) {
                            headers['Prefer'] = 'resolution=merge-duplicates';
                        }
                        
                        return fetch(url, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(data)
                        }).then(function(response) {
                            return response.json();
                        });
                    },
                    
                    update: function(data, options) {
                        var url = self.supabaseUrl + '/rest/v1/' + table;
                        var headers = {
                            'apikey': self.supabaseKey,
                            'Authorization': 'Bearer ' + self.supabaseKey,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        };
                        
                        return fetch(url, {
                            method: 'PATCH',
                            headers: headers,
                            body: JSON.stringify(data)
                        }).then(function(response) {
                            return response.json();
                        });
                    },
                    
                    delete: function() {
                        var url = self.supabaseUrl + '/rest/v1/' + table;
                        return fetch(url, {
                            method: 'DELETE',
                            headers: {
                                'apikey': self.supabaseKey,
                                'Authorization': 'Bearer ' + self.supabaseKey
                            }
                        }).then(function(response) {
                            return response.json();
                        });
                    }
                };
            };

            return new SupabaseClient(url, key);
        }
    };
})(window);
